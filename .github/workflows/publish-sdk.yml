name: ğŸš€ Publish CloudX SDK

on:
  push:
    tags:
      - 'v-sdk-*'

env:
  ANDROID_HOME: /Users/administrator/Library/Android/sdk

jobs:
  determine-sdk:
    runs-on: self-hosted
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
      shouldPublish: ${{ steps.extract-version.outputs.shouldPublish }}
    steps:
      - name: ğŸ· Extract version from tag
        id: extract-version
        run: |
          if [[ "${{ github.ref_name }}" == v-sdk-* ]]; then
            echo "version=${GITHUB_REF_NAME#v-sdk-}" >> $GITHUB_OUTPUT
            echo "shouldPublish=true" >> $GITHUB_OUTPUT
          else
            echo "No matching SDK tag pattern. Skipping..."
            echo "shouldPublish=false" >> $GITHUB_OUTPUT
            exit 0
          fi

  publish-sdk:
    needs: determine-sdk
    runs-on: self-hosted
    if: ${{ needs.determine-sdk.outputs.shouldPublish == 'true' }}
    name: ğŸ“¦ Publish CloudX SDK
    steps:
      - name: ğŸ§¾ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: ğŸ” Make Gradle executable
        run: chmod +x ./gradlew

      # Additional SDK checks can be added here
      - name: ğŸ§ª Run SDK Tests (placeholder)
        run: |
          echo "ğŸ§ª Running SDK-specific tests and checks..."
          # ./gradlew :sdk:test
          # Add other SDK-specific validation steps here

      - name: ğŸ•µï¸ Log Maven Central and GPG Secrets (partially)
        run: |
          echo "ğŸ” mavenCentralUsername: ${ORG_GRADLE_PROJECT_mavenCentralUsername:0:4}"
          echo "ğŸ” mavenCentralPassword is set: [${#ORG_GRADLE_PROJECT_mavenCentralPassword}] characters"
          echo "ğŸ” signingInMemoryKey is set: $([ -z \"$ORG_GRADLE_PROJECT_signingInMemoryKey\" ] && echo 'âŒ NO' || echo 'âœ… YES')"
          echo "ğŸ” signingInMemoryKeyPassword is set: $([ -z \"$ORG_GRADLE_PROJECT_signingInMemoryKeyPassword\" ] && echo 'âŒ NO' || echo 'âœ… YES')"
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.ORG_GRADLE_PROJECT_mavenCentralUsername }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.ORG_GRADLE_PROJECT_mavenCentralPassword }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.ORG_GRADLE_PROJECT_signingInMemoryKey }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.ORG_GRADLE_PROJECT_signingInMemoryKeyPassword }}

      - name: ğŸ› ï¸ Build SDK Release AAR
        run: ./gradlew :sdk:assembleRelease -Pcloudx.endpoint.config=https://example.com/config.json -Pversion=${{ needs.determine-sdk.outputs.version }}

      - name: ğŸ“¦ Publish SDK to Maven Central
        run: ./gradlew :sdk:publishToMavenCentral --no-daemon --stacktrace -Pcloudx.endpoint.config=https://example.com/config.json -Pversion=${{ needs.determine-sdk.outputs.version }}
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.ORG_GRADLE_PROJECT_mavenCentralUsername }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.ORG_GRADLE_PROJECT_mavenCentralPassword }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.ORG_GRADLE_PROJECT_signingInMemoryKey }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.ORG_GRADLE_PROJECT_signingInMemoryKeyPassword }}

      - name: ğŸ“¤ Upload SDK AAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sdk-release-${{ needs.determine-sdk.outputs.version }}
          path: sdk/build/outputs/aar/sdk-release.aar

#      - name: ğŸš€ Create GitHub Release with SDK AAR
#        uses: softprops/action-gh-release@v1
#        with:
#          name: Release ${{ github.ref_name }}
#          tag_name: ${{ github.ref_name }}
#          files: sdk/build/outputs/aar/sdk-release.aar
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}